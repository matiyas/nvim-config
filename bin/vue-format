#!/usr/bin/env node

const fs = require("fs")
const { execSync } = require("child_process")

let input = ""
process.stdin.setEncoding("utf8")
process.stdin.on("data", (chunk) => (input += chunk))
process.stdin.on("end", () => {
  try {
    const result = formatVue(input)
    process.stdout.write(result)
  } catch (e) {
    console.error(e.message)
    process.exit(1)
  }
})

function formatVue(content) {
  const templateMatch = content.match(/<template(\s[^>]*)?>([\s\S]*?)<\/template>/i)
  const scriptMatch = content.match(/<script(\s[^>]*)?>([\s\S]*?)<\/script>/i)
  const styleMatch = content.match(/<style(\s[^>]*)?>([\s\S]*?)<\/style>/i)

  let result = ""

  if (templateMatch) {
    const templateAttrs = templateMatch[1] || ""
    const templateContent = templateMatch[2]
    const formattedTemplate = formatHtml(templateContent)
    const indentedTemplate = formattedTemplate
      .split("\n")
      .map(line => line.length > 0 ? "  " + line : line)
      .join("\n")
    result += "<template" + templateAttrs + ">\n" + indentedTemplate + "\n</template>\n"
  }

  if (scriptMatch) {
    const scriptAttrs = scriptMatch[1] || ""
    const scriptContent = scriptMatch[2]
    const formattedScript = formatWithPrettier(scriptContent.trim(), "babel")
    result += "\n<script" + scriptAttrs + ">\n" + formattedScript + "\n</script>\n"
  }

  if (styleMatch) {
    const styleAttrs = styleMatch[1] || ""
    const styleContent = styleMatch[2]
    const lang = styleAttrs.includes("scss") ? "scss" : "css"
    const formattedStyle = formatWithPrettier(styleContent.trim(), lang)
    result += "\n<style" + styleAttrs + ">\n" + formattedStyle + "\n</style>\n"
  }

  return result
}

function formatHtml(html) {
  const tmpFile = "/tmp/vue-format-" + process.pid + ".html"
  fs.writeFileSync(tmpFile, html)

  try {
    const result = execSync(
      "npx js-beautify --type html --indent-size 2 --wrap-attributes force-aligned --wrap-line-length 120 --indent-inner-html --preserve-newlines --max-preserve-newlines 2 " + tmpFile,
      { encoding: "utf8", maxBuffer: 10 * 1024 * 1024 }
    )
    return result.trimEnd()
  } finally {
    fs.unlinkSync(tmpFile)
  }
}

function formatWithPrettier(code, parser) {
  const tmpFile = "/tmp/vue-format-" + process.pid + "-" + parser + ".tmp"
  fs.writeFileSync(tmpFile, code)

  try {
    const result = execSync(
      "npx prettier --parser " + parser + " --semi false --single-quote --trailing-comma none --tab-width 2 --print-width 120 " + tmpFile,
      { encoding: "utf8", maxBuffer: 10 * 1024 * 1024 }
    )
    return result.trimEnd()
  } finally {
    fs.unlinkSync(tmpFile)
  }
}
